#!/usr/bin/env bash
set -euo pipefail

# single-file-react-docker.sh
# Creates a minimal React app, a multi-stage Dockerfile (production), nginx config,
# builds the Docker image and runs the container.

APP_DIR="react-docker-single"
IMAGE_NAME="my-react-app:latest"
HOST_PORT=3000

# Check prerequisites
command -v node >/dev/null 2>&1 || { echo "Node.js is required. Install Node.js (v16+)."; exit 1; }
command -v npm >/dev/null 2>&1 || { echo "npm is required. Install Node.js/npm."; exit 1; }
command -v docker >/dev/null 2>&1 || { echo "Docker is required. Install Docker and ensure it is running."; exit 1; }

# Create project directory
rm -rf "$APP_DIR"
mkdir -p "$APP_DIR"
cd "$APP_DIR"

# package.json
cat > package.json <<'JSON'
{
  "name": "react-docker-single",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-scripts": "5.0.1"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test --env=jsdom --watchAll=false",
    "eject": "react-scripts eject"
  }
}
JSON

# .dockerignore
cat > .dockerignore <<'DOCKERIGNORE'
node_modules
build
.dockerignore
Dockerfile
docker-compose*.yml
.git
.gitignore
README.md
.env
.vscode
DOCKERIGNORE

# public/index.html
mkdir -p public
cat > public/index.html <<'HTML'
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>React Docker Single File Demo</title>
  </head>
  <body>
    <div id="root"></div>
    <script src="/static/js/bundle.js"></script>
  </body>
</html>
HTML

# src files
mkdir -p src
cat > src/index.js <<'JS'
import React from 'react';
import { createRoot } from 'react-dom/client';
import App from './App';
import './index.css';

const container = document.getElementById('root');
const root = createRoot(container);
root.render(<App />);
JS

cat > src/App.js <<'JS'
import React from 'react';

export default function App(){
  return (
    <div style={{fontFamily:'Arial, sans-serif', padding:20}}>
      <h1>React App â€” Dockerized (Multi-stage)</h1>
      <p>This is a minimal React app created by <code>single-file-react-docker.sh</code>.</p>
      <button onClick={()=> alert('Hello from React in Docker!')}>Click me</button>
    </div>
  );
}
JS

cat > src/index.css <<'CSS'
body { margin: 0; padding: 0; }
CSS

# Dockerfile (multi-stage)
cat > Dockerfile <<'DOCKER'
# Stage 1 - build
FROM node:18-alpine AS build
WORKDIR /app
COPY package.json package-lock.json* ./
RUN if [ -f package-lock.json ]; then npm ci --silent; else npm install --silent; fi
COPY . .
ENV NODE_ENV=production
RUN npm run build

# Stage 2 - serve with nginx
FROM nginx:stable-alpine
RUN rm -rf /usr/share/nginx/html/*
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
DOCKER

# nginx.conf
cat > nginx.conf <<'NGINX'
server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|ico|ttf|woff2?)$ {
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
NGINX

# Optional: helpful README
cat > README.md <<'MD'
# React Docker Single-file Demo

This directory was generated by `single-file-react-docker.sh`.

What this script did:
- created a minimal React app (using react-scripts)
- created a multi-stage Dockerfile that builds the app and serves it with nginx

How to build & run (already performed if you ran this script):

  # Build the Docker image
  docker build -t my-react-app:latest .

  # Run the container (maps container port 80 to host 3000)
  docker run --rm -p 3000:80 my-react-app:latest

Open http://localhost:3000
MD

# Install node modules and build
printf "\nInstalling npm dependencies (this may take a few minutes)...\n"
npm install --silent

printf "\nBuilding production bundle (npm run build)...\n"
npm run build --silent

# Build Docker image
printf "\nBuilding Docker image: %s\n" "$IMAGE_NAME"
docker build -t "$IMAGE_NAME" .

# Run Docker container
printf "\nRunning container and mapping host:%d -> container:80\n" "$HOST_PORT"

docker run --rm -p ${HOST_PORT}:80 --name react-docker-single-run "$IMAGE_NAME"

# End of script
